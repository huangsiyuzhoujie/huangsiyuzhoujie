<!DOCTYPE html>













<html class="theme-next gemini" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">

<meta name="google-site-verification" content="jgw73iXouBAJcOuff0yi9vdSNDecBSOUXacsHJszpmo" />
<meta name="baidu-site-verification" content="xyf9WD2vvl" />











<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/apple-icon-57x57.png?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_body":"slideDownIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="一. 项目简介在实际生产环境下, 当我们的深度学习模型训练完成后, 我们通常需要将预测模型部署到嵌入式平台上才能正式产生效益, 但是在模型部署过程中, 脱离了训练环境, 就会产生各种依赖问题, 使得部署过程十分麻烦, 另外, 一般的用户对现在流行的神经网络前向计算框架如 TensorRT, NCNN, OpenVINO 等加速引擎的诸多细节都无法清楚理解, 尤其是对于专注于算法提升的算法人员来说,">
<meta property="og:type" content="article">
<meta property="og:title" content="【置顶】通用深度学习推理框架-EasyInfer">
<meta property="og:url" content="https://hellozhaozheng.github.io/z_post/项目-EasyInfer/index.html">
<meta property="og:site_name" content="从零开始的BLOG">
<meta property="og:description" content="一. 项目简介在实际生产环境下, 当我们的深度学习模型训练完成后, 我们通常需要将预测模型部署到嵌入式平台上才能正式产生效益, 但是在模型部署过程中, 脱离了训练环境, 就会产生各种依赖问题, 使得部署过程十分麻烦, 另外, 一般的用户对现在流行的神经网络前向计算框架如 TensorRT, NCNN, OpenVINO 等加速引擎的诸多细节都无法清楚理解, 尤其是对于专注于算法提升的算法人员来说,">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://wx3.sinaimg.cn/large/d7b90c85ly1g0oqlor8e1j20tq0ds0u0.jpg">
<meta property="og:image" content="https://wx4.sinaimg.cn/large/d7b90c85ly1g0oqi9rwlyj20v50crgmh.jpg">
<meta property="og:image" content="https://wx1.sinaimg.cn/large/d7b90c85ly1g0oqix3d83j20uh0ayaao.jpg">
<meta property="og:image" content="https://wx4.sinaimg.cn/large/d7b90c85ly1g0oqi9rwlyj20v50crgmh.jpg">
<meta property="og:updated_time" content="2019-07-12T13:09:59.284Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="【置顶】通用深度学习推理框架-EasyInfer">
<meta name="twitter:description" content="一. 项目简介在实际生产环境下, 当我们的深度学习模型训练完成后, 我们通常需要将预测模型部署到嵌入式平台上才能正式产生效益, 但是在模型部署过程中, 脱离了训练环境, 就会产生各种依赖问题, 使得部署过程十分麻烦, 另外, 一般的用户对现在流行的神经网络前向计算框架如 TensorRT, NCNN, OpenVINO 等加速引擎的诸多细节都无法清楚理解, 尤其是对于专注于算法提升的算法人员来说,">
<meta name="twitter:image" content="https://wx3.sinaimg.cn/large/d7b90c85ly1g0oqlor8e1j20tq0ds0u0.jpg">






  <link rel="canonical" href="https://hellozhaozheng.github.io/z_post/项目-EasyInfer/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>【置顶】通用深度学习推理框架-EasyInfer | 从零开始的BLOG</title>
  






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?21a4899cc63d3c11a3d90ac58074a19c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">从零开始的BLOG</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">与其感慨路难行，不如马上出发</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档<span class="badge">263</span></a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-计算机视觉">
    <a href="/categories/计算机视觉/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tripadvisor"></i> <br />计算机视觉</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-深度学习">
    <a href="/categories/深度学习/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-drupal"></i> <br />深度学习</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-caffe2">
    <a href="/categories/Caffe2/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-coffee"></i> <br />Caffe2</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-pytorch">
    <a href="/categories/PyTorch/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-free-code-camp"></i> <br />PyTorch</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-c++">
    <a href="/categories/Cpp/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-codiepie"></i> <br />C++</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-python">
    <a href="/categories/Python/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-product-hunt"></i> <br />Python</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-项目">
    <a href="/categories/项目/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-connectdevelop"></i> <br />项目</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-cuda">
    <a href="/categories/CUDA/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-braille"></i> <br />CUDA</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-其他">
    <a href="/categories/其他/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />其他</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签<span class="badge">40</span></a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于我</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />站内搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="站内搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
    
      
    
    <a href="https://github.com/hellozhaozheng" class="github-corner" target="_blank" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#222; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg>
    
      </a>
    



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://hellozhaozheng.github.io/z_post/项目-EasyInfer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ZeroZone">
      <meta itemprop="description" content="并不是什么厉害的地方<br>只是一个安静的学习角落">
      <meta itemprop="image" content="/images/avatar_zz.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="从零开始的BLOG">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">【置顶】通用深度学习推理框架-EasyInfer
              
            
          </h1>
        

        <div class="post-meta">
	
	     <i class="fa fa-thumb-tack"></i>
	    <font style="color:#999">置顶</font>
	    <span class="post-meta-divider">|</span>
	
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-01-15 17:01:48" itemprop="dateCreated datePublished" datetime="2019-01-15T17:01:48+08:00">2019-01-15</time>
            

            
          </span>

	  
  	    <span class="post-updated">
    		&nbsp; | &nbsp; 更新于
    		<time itemprop="dateUpdated" datetime="2019-07-12T21:09:59+08:00" content="2019-07-12">
      		  2019-07-12
    		</time>
  	  </span>
	  

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/项目/" itemprop="url" rel="index"><span itemprop="name">项目</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon"
            >
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">23k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">21 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="一-项目简介"><a href="#一-项目简介" class="headerlink" title="一. 项目简介"></a>一. 项目简介</h1><p>在实际生产环境下, 当我们的深度学习模型训练完成后, 我们通常需要将预测模型部署到嵌入式平台上才能正式产生效益, 但是在模型部署过程中, 脱离了训练环境, 就会产生各种依赖问题, 使得部署过程十分麻烦, 另外, 一般的用户对现在流行的神经网络前向计算框架如 TensorRT, NCNN, OpenVINO 等加速引擎的诸多细节都无法清楚理解, 尤其是对于专注于算法提升的算法人员来说, 更是无暇顾及. 因此, 我们开发了一个通用的神经网络前向计算框架: <strong>EasyInfer</strong>, 之所以说它通用, 是因为它的底层支持调用 NCNN, TensorRT 和 OpenVINO 三种不同的引擎, 同时, 可以支持多种模型格式的输入, 包括 MXNet, Caffe, Onnx 等, 未来还计划支持 PyTorch 和 TensorFlow. 同时还提供了 C, C++ 和 Python 三套接口, 并且可以支持 Linux, Windows 以及 OSX 系统, 未来计划支持 Android 和 IOS 系统.当用户需要快速验证模型在部署环境下的性能或效率时, 只需要掌握 EasyInfer 提供的自定义引擎开发接口和自定义模型开发接口, 就可以根据自己的需求快速的完成模型的部署, 同时还能灵活的选择和切换底层的推理引擎, 大大地节省了算法和部署人员的时间成本.</p>
<h2 id="源码架构"><a href="#源码架构" class="headerlink" title="源码架构"></a>源码架构</h2><p>EasyInfer 的整体代码架构如下图所示, 首先 EasyInfer 本身并不是一个独立的前向计算引擎, 它实际上可以看做是众多主流加速引擎的一个代理, 用户通过调用 EasyInfer 统一的 API 接口, 可以自由灵活的切换底层使用的加速引擎, 如图中所示, 我们目前提供了三种加速引擎的支持, 分别是 NCNN, TensorRT 以及 OpenVINO. 其中, NCNN 加速引擎已经作为一个子模块被内置到 EasyInfer 源码中, 用户无需单独编译和安装 NCNN 就可以直接使用 EasyInfer 进行模型部署(默认调用 NCNN 引擎). 对于其他的加速引擎, 用户只需要安装官网的安装教程完成引擎安装, 就可以在代码中改变需要调用的引擎. 而对于一些特殊的网络层, 有些推理引擎可能没有提供相应的接口. 例如 Slice 层, 在 TensorRT 中就没有对应的层与之匹配, 对于这种情况, 我们也提供了相应的插件可以让用户使用, 目的就是为了让用户更加方便无痛地完成模型的转换和部署(如图中的 TRTPlugin Factory 所示).</p>
<p><img src="https://wx3.sinaimg.cn/large/d7b90c85ly1g0oqlor8e1j20tq0ds0u0.jpg" alt=""></p>
<h2 id="模型转换"><a href="#模型转换" class="headerlink" title="模型转换"></a>模型转换</h2><p>在 EasyInfer 的工作流程中, 很重要的第一步工作就是将用户提供的模型文件转换成底层引擎使用的模型文件格式, 如下图所示, 目前我们已经支持将 Caffe, Onnx, 和 MXNet 模型全自动的转换到不同的底层引擎模型格式. 其中, 对于 MXNet 模型文件, 起初由于我们是开发了一个将 MXNet 模型文件转换成 Caffe 模型文件的工具, 但是后来我们发现, 有些 MXNet 网络的参数在 Caffe 中不支持, 并且 Caffe 目前已经处于停止维护的状态, 因此, 我们决定重新编写将 MXNet 网络模型直接转换成底层引擎模型格式的代码, 但是对于 TensorRT 来说, 由于它没有提供现成可用的 MXNet 解析类, 因此, 我们必须手动实现对 MXNet 模型文件的解析, 然后将解析后的结果存入 TensorRT 模型中. 这一部分的任务也是我的任务之一, 关于这一部分的细节会在后文介绍.</p>
<p><img src="https://wx4.sinaimg.cn/large/d7b90c85ly1g0oqi9rwlyj20v50crgmh.jpg" alt=""></p>
<h2 id="模型运行"><a href="#模型运行" class="headerlink" title="模型运行"></a>模型运行</h2><p>在完成模型转换后(我们会将模型统一转换成指定的格式, 这里我们用 EasyModel 指代这些转换后的模型). 我们就可以根据我们的模型和需要来编写相应的代码完成模型部署工作. 这里我们为用户提供了极简的引擎开发接口和模型开发接口: <strong>ModelBase</strong>. ModelBase 在整个模型执行流程中扮演了一个非常重要的角色, 它会接受来自用户提供的转换后的模型文件, 同时会调用底层的 EasyEngine 引擎代理, 然后根据用户提供的不同输入, 做出相应的预测结果, 如下图所示.<br><img src="https://wx1.sinaimg.cn/large/d7b90c85ly1g0oqix3d83j20uh0ayaao.jpg" alt=""></p>
<p>上图中的 ModelBase 是所有模型组件的基类, 是模型到引擎的桥梁, 也是整个 EasyInfer 的核心, 它面向算法研发人员封装了引擎操作的细节, 仅暴露极简的接口实现图像数据的输入和输出. 其主要接口(并非所有接口, 这里只介绍最主要的一些接口)有:</p>
<ul>
<li><code>LoadModelFromFile</code>: 面向最终用户, 加载 EasyModel 文件, 并提供加密接口(模型文件是由用户提供的, 因为本项目的最终计划是要进行商业部署, 因此, 用户提供的模型必须是经过加密的)</li>
<li><code>_UploadImage</code>: 加载输入图像</li>
<li><code>_UploadData</code>: 加载自定义格式数据</li>
<li><code>_Calculate</code>: 执行运行</li>
<li><code>_GetOutput</code>: 获取输出</li>
</ul>
<p>当我们想要利用上述接口编写一个 Model 类时, 我们需要做以下六件事:</p>
<ol>
<li>准备模型文件, 编写模型文件的配置文件(<code>.json</code>);</li>
<li>利用提供的工具计算模型的摘要信息(MD5);</li>
<li>从 ModelBase 继承一个子类, 填入模型的名称和摘要信息;</li>
<li>设计用户接口函数, 提供用户输入;</li>
<li>设定图像各通道的 mean 和 var;</li>
<li>移植前处理和后处理代码.</li>
</ol>
<h2 id="ModelBase-实例"><a href="#ModelBase-实例" class="headerlink" title="ModelBase 实例"></a>ModelBase 实例</h2><p>下面我们会根据上一小节 Model 类的编写流程完成一个简单的示例, 以更好的说明如何使用 EasyInfer 来加速模型部署. 我们以人脸角度模型为例:</p>
<h3 id="C-接口用法"><a href="#C-接口用法" class="headerlink" title="C++ 接口用法"></a>C++ 接口用法</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EXPORT</span> <span class="title">Angle</span> :</span> <span class="keyword">public</span> ModelBase &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Angle();</span><br><span class="line">    cv::<span class="function">Point3f <span class="title">EstimateAngles</span><span class="params">(cv::Mat img, <span class="keyword">const</span> cv::Rect &amp;faceBox)</span></span>;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">float</span> _Result2Angle(<span class="keyword">const</span> <span class="keyword">float</span>* pBuf) <span class="keyword">const</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Angle::Angle() : ModelBase(<span class="string">"angle"</span>, <span class="string">"266e697c57339b515bb0b24cac167eb5"</span>) &#123;</span><br><span class="line">    _SetGammaBeta(<span class="number">0</span>, <span class="number">1.f</span> / <span class="number">57.63f</span>, <span class="number">-103.53f</span> / <span class="number">57.63f</span>);</span><br><span class="line">    _SetGammaBeta(<span class="number">1</span>, <span class="number">1.f</span> / <span class="number">57.63f</span>, <span class="number">-116.28f</span> / <span class="number">57.63f</span>);</span><br><span class="line">    _SetGammaBeta(<span class="number">2</span>, <span class="number">1.f</span> / <span class="number">57.63f</span>, <span class="number">-123.675f</span> / <span class="number">57.63f</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> Angle::_Result2Angle(<span class="keyword">const</span> <span class="keyword">float</span>* pBuf) <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="keyword">float</span> fSum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; CLASS_NUM; ++i) &#123;</span><br><span class="line">        fSum += pBuf[i] * i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fSum * <span class="number">3</span> - <span class="number">99</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cv::Point3f Angle::EstimateAngles(cv::Mat img, <span class="keyword">const</span> cv::Rect &amp;_box) &#123;</span><br><span class="line">    <span class="keyword">const</span> cv::Scalar fillColor = cv::Scalar(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">float</span> fExpandScale = <span class="number">1.8f</span>;</span><br><span class="line">    cv::Rect faceBox = BoundingSquare(_box);</span><br><span class="line">    faceBox = ScaleRect2f(faceBox, fExpandScale);</span><br><span class="line">    _CalculateSingleImage(<span class="string">"data"</span>, CropRect(img, faceBox, fillColor), <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">auto</span> &amp;outYaw = _GetOutput(OUTNAME_YAW);</span><br><span class="line">    <span class="keyword">auto</span> &amp;outPitch = _GetOutput(OUTNAME_PITCH);</span><br><span class="line">    <span class="keyword">auto</span> &amp;outRoll = _GetOutput(OUTNAME_ROLL);</span><br><span class="line">    CHECK_EQ(outYaw.shape[<span class="number">0</span>], CLASS_NUM);</span><br><span class="line">    CHECK_EQ(outPitch.shape[<span class="number">0</span>], CLASS_NUM);</span><br><span class="line">    CHECK_EQ(outRoll.shape[<span class="number">0</span>], CLASS_NUM);</span><br><span class="line">    <span class="keyword">return</span> &#123;_Result2Angle(outYaw.data.data()),</span><br><span class="line">               _Result2Angle(outPitch.data.data()),</span><br><span class="line">               _Result2Angle(outRoll.data.data())&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Python-接口用法"><a href="#Python-接口用法" class="headerlink" title="Python 接口用法"></a>Python 接口用法</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> sys sys.path.append(<span class="string">'../build/python'</span>) <span class="keyword">import</span> eibase</span><br><span class="line"><span class="keyword">import</span> eiface</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Angle</span>:</span></span><br><span class="line">    modelObj = <span class="keyword">None</span></span><br><span class="line">    angleNum = <span class="number">66</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, modelFile)</span>:</span></span><br><span class="line">        self.modelObj = eibase.EasyModel(<span class="string">"angle"</span>, <span class="string">"266e697c57339b515bb0b24cac167eb5"</span>)</span><br><span class="line">        self.modelObj.SetGammaBeta(<span class="number">0</span>, <span class="number">1.</span> / <span class="number">57.63</span>, <span class="number">-103.53</span> / <span class="number">57.63</span>);</span><br><span class="line">        self.modelObj.SetGammaBeta(<span class="number">1</span>, <span class="number">1.</span> / <span class="number">57.63</span>, <span class="number">-116.28</span> / <span class="number">57.63</span>);</span><br><span class="line">        self.modelObj.SetGammaBeta(<span class="number">2</span>, <span class="number">1.</span> / <span class="number">57.63</span>, <span class="number">-123.675</span> / <span class="number">57.63</span>);</span><br><span class="line">        self.modelObj.LoadModelFromFile(modelFile);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Result2Angle</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        data = data.flatten()</span><br><span class="line">        sum = <span class="number">0.</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, self.angleNum):</span><br><span class="line">            sum += data[i] * i</span><br><span class="line">        <span class="keyword">return</span> sum * <span class="number">3</span> - <span class="number">99</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">EstimateAngles</span><span class="params">(self, img, rect)</span>:</span></span><br><span class="line">        expandScale = <span class="number">1.8</span></span><br><span class="line">        fillColor = (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        faceBox = eiface.BoundingSquare(rect[<span class="number">0</span>], rect[<span class="number">1</span>])</span><br><span class="line">        faceBox = eiface.ScaleRect2f(faceBox[<span class="number">0</span>], faceBox[<span class="number">1</span>], expandScale)</span><br><span class="line">        img = eiface.CropRect(img, faceBox[<span class="number">0</span>], faceBox[<span class="number">1</span>], fillColor)</span><br><span class="line">        self.modelObj.UploadImage(<span class="string">"data"</span>, img, <span class="keyword">True</span>)</span><br><span class="line">        self.modelObj.Calculate()</span><br><span class="line">        outYaw = self.modelObj.GetOutput(<span class="string">"yaw"</span>);</span><br><span class="line">        outPitch = self.modelObj.GetOutput(<span class="string">"pitch"</span>);</span><br><span class="line">        outRoll = self.modelObj.GetOutput(<span class="string">"roll"</span>);</span><br><span class="line">        <span class="keyword">return</span> (self.Result2Angle(outYaw),</span><br><span class="line">                self.Result2Angle(outPitch),</span><br><span class="line">                self.Result2Angle(outRoll))</span><br></pre></td></tr></table></figure>
<p><strong>请注意</strong>:用 Python 实现的模型算法组件，EasyInfer 无法保证其跨平台兼容性和多语言支持。 因为Python解释器不是到处都有，版本也不统一, 因此, 目前 Python 接口的兼容性仍处于开发和完善当中.</p>
<h1 id="二-负责任务"><a href="#二-负责任务" class="headerlink" title="二. 负责任务"></a>二. 负责任务</h1><p>在 EasyInfer 项目中, 我主要承担了三部分任务, 分别为:</p>
<ol>
<li>将 MXNet 模型转换成 TensorRT 模型, 为 EasyInfer 的底层引擎添加 MXNet 模型文件支持.</li>
<li>为 EasyInfer 提供封装完善的 C 接口</li>
<li>添加 OPENVINO 推理引擎底层支持</li>
</ol>
<p>下面, 我将会详细介绍这三部分任务在 EasyInfer 项目中的功能和细节.</p>
<h2 id="1-MXNet-模型到-TensorRT-模型的转换"><a href="#1-MXNet-模型到-TensorRT-模型的转换" class="headerlink" title="1. MXNet 模型到 TensorRT 模型的转换"></a>1. MXNet 模型到 TensorRT 模型的转换</h2><p>在上一节中模型转换的示意图中, 我们可以看到, EasyInfer 最初在接受 MXNet 文件时的处理办法是, 是首先利用一个 mxnet2caffe 模型转换工具将 MXNet 模型文件转换成对应的 Caffe 模型文件, 然后再对 Caffe 模作为输入送入到 EngineConvert 模块中去, 最终生成相应的 EasyModel 模型文件(引擎相关的单一文件). 如下图所示.</p>
<p><img src="https://wx4.sinaimg.cn/large/d7b90c85ly1g0oqi9rwlyj20v50crgmh.jpg" alt=""></p>
<p>但是在后来的开发中我们发现, 有些 MXNet 网络层的参数在 Caffe 中不支持, 并且 Caffe 目前已经处于停止维护的状态, 因此, 我们决定重新实现模型转换部分的相关代码, 使得可以将 MXNet 的模型文件直接作为输入传给 EngineConvert 模块, 然后生成相应底层引擎的单一模型文件. 这部分的功能主要由我来负责, 我采取的实现思路如下所示:</p>
<ol>
<li>设计能够封装 MXNet 模型文件信息的数据结构.</li>
<li>解析 MXNet 模型文件(.json 和 .params), 并将解析出来的信息存储到设计好的数据结构中.</li>
<li>根据节点的输入输出关系, 对网络层节点进行排序, 将各个网络层串接起来, 以确保每个网络层所处的位置正确.</li>
<li>设计 Mxnet 模型对应的 proto 数据结构, 完成对 MxnetNode 和 MxnetParams 的封装</li>
<li>根据封装好的 protobuf 数据, 填充 TensorRT 的 <code>INetworkDefinition</code> 实例对象</li>
<li>将填充好的 <code>INetworkDefinition</code> 返回, 完成引擎模型的转换工作.</li>
</ol>
<p>下面, 我将会对每一个步骤的设计和实现进行介绍:</p>
<h3 id="1-设计能够封装-MXNet-模型文件信息的数据结构"><a href="#1-设计能够封装-MXNet-模型文件信息的数据结构" class="headerlink" title="(1). 设计能够封装 MXNet 模型文件信息的数据结构."></a>(1). 设计能够封装 MXNet 模型文件信息的数据结构.</h3><p>对于 MXNet 模型文件来说, 它的网络结构描述放置在 <code>.json</code> 结尾的配置文件中, 其神经网络的每一个网络层在 <code>.json</code> 中都是以一个节点来表示的, 节点与节点之间的连接关系也是通过自身的 <code>inputs</code> 属性决定的, 为此, 首先设计出用于表示模型网络结构的数据结构, 将其命名为 MXNet, 其实现形式如下所示<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MxnetInput = <span class="built_in">std</span>::pair&lt;<span class="keyword">size_t</span>, <span class="keyword">size_t</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MxnetNode</span> &#123;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> strName;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> strOp;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;MxnetInput&gt; inputs;</span><br><span class="line">    Attributes attrs;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>上面的定义中, <code>strName</code>代表了节点的名字, <code>strOp</code>代表了节点的操作类型(卷积, 池化等), <code>inputs</code>是一个<code>pair</code>类型的数据结构, 它记录了当前节点的输入层的编号, 最后是代表节点其他属性的一个封装类的实例对象, 该属性类的定义如下所示:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> StringPair = <span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="built_in">std</span>::<span class="built_in">string</span>&gt;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Attributes</span> :</span> <span class="keyword">public</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;StringPair&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Attributes() = <span class="keyword">default</span>;</span><br><span class="line">    Attributes(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;StringPair&gt; &amp;baseObj);</span><br><span class="line">    <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">GetValue</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;strKey, <span class="keyword">bool</span> bRequired)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">HasValue</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;strKey)</span> <span class="keyword">const</span></span>;</span><br><span class="line">    boolRemoveValue(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;strKey);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;StringPair&gt;::iterator _Find(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;strKey);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;StringPair&gt;::const_iterator_Find(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;strKey) <span class="keyword">const</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-解析-MXNet-模型文件-json-和-params"><a href="#2-解析-MXNet-模型文件-json-和-params" class="headerlink" title="(2). 解析 MXNet 模型文件(.json 和 .params)"></a>(2). 解析 MXNet 模型文件(.json 和 .params)</h3><p>解析 MXNet 的<code>.json</code>文件时, 需要借助一个<code>.json</code>解析类, 该类会将<code>.json</code>文件中的信息按照字段的类别进行存储, 拿到这些信息后, 将相应字段的内容填充到<code>MxnetNode</code>数据结构中即可.<br>而对于 MXNet 的<code>.params</code>参数文件, 可以根据<code>.json</code>文件中提供的信息获取到参数的个数, 然后根据参数的数据类型和占用的字节总数, 通过<code>fread()</code>函数完成参数数值的获取, 之后将其存储到<code>MxnetParams</code>数据结构中即可. 由于解析模型部分的代码较多, 因此这里只给出一些重要函数的声明和调用关系, 更细节的部分不再贴出, 具体代码如下所示:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"json_helper.hpp"</span> <span class="comment">// 定义了json的辅助解析工具</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">MxnetNode <span class="title">ParseMxnetNode</span><span class="params">(Json::iterator jNode)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;MxnetNode&gt; ParseMxnetJson(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;strFile,</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">size_t</span>&gt; &amp;headIndices); <span class="comment">// 内部会调用 ParseMxnetNode 函数</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;MxnetParam&gt; LoadMxnetParam(<span class="built_in">std</span>::<span class="built_in">string</span> strModelFn); <span class="comment">// strModelFN 为 .params 文件的路径</span></span><br></pre></td></tr></table></figure></p>
<h3 id="3-根据节点的输入输出关系-对网络层节点进行排序"><a href="#3-根据节点的输入输出关系-对网络层节点进行排序" class="headerlink" title="(3). 根据节点的输入输出关系, 对网络层节点进行排序"></a>(3). 根据节点的输入输出关系, 对网络层节点进行排序</h3><p>我们知道, MXNet 的<code>.json</code>文件中, 节点是以编号的形式来记录的, 因此, 将节点的信息存储了以后, 为了后续流程能够更加方便的进行, 还需要按照节点的<code>inputs</code>属性对网络中的节点进行排序, 由于网络中节点的输入来源可能不止一个, 因此, 这里的排序使用了深度优先的遍历算法, 具体的代码实现如下所示:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">size_t</span>&gt; GetSortedIndicesByDependencies(</span><br><span class="line">		<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;MxnetNode&gt; &amp;nodeAry,</span><br><span class="line">		<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">size_t</span>&gt; &amp;headIndices) &#123;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">size_t</span>, <span class="keyword">size_t</span>&gt; nodesLevel;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; nodeAry.size(); ++i) &#123;</span><br><span class="line">		nodesLevel[i] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">std</span>::function&lt;<span class="keyword">void</span>(<span class="keyword">size_t</span>, <span class="keyword">size_t</span>)&gt; VisitTree;</span><br><span class="line">	VisitTree = [&amp;](<span class="keyword">size_t</span> iNode, <span class="keyword">size_t</span> nLevel) &#123;</span><br><span class="line">			CHECK_LT(iNode, nodesLevel.size());</span><br><span class="line">			nodesLevel[iNode] = <span class="built_in">std</span>::max(nodesLevel[iNode], nLevel);</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">auto</span> iInput : nodeAry[iNode].inputs) &#123;</span><br><span class="line">				VisitTree(iInput.first, nLevel + <span class="number">1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span> iHead : headIndices) &#123;</span><br><span class="line">		VisitTree(iHead, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">size_t</span>&gt; results(nodeAry.size());</span><br><span class="line">	<span class="built_in">std</span>::iota(results.begin(), results.end(), <span class="number">0</span>);</span><br><span class="line">	<span class="built_in">std</span>::stable_sort(results.begin(), results.end(),</span><br><span class="line">			[&amp;](<span class="keyword">size_t</span> i1, <span class="keyword">size_t</span> i2)&#123;</span><br><span class="line">				<span class="keyword">return</span> nodesLevel[i1] &gt; nodesLevel[i2];</span><br><span class="line">			&#125;</span><br><span class="line">		);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">std</span>::move(results);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-设计-Mxnet-模型对应的-proto-数据结构-完成对-MxnetNode-和-MxnetParams-的封装"><a href="#4-设计-Mxnet-模型对应的-proto-数据结构-完成对-MxnetNode-和-MxnetParams-的封装" class="headerlink" title="(4). 设计 Mxnet 模型对应的 proto 数据结构, 完成对 MxnetNode 和 MxnetParams 的封装"></a>(4). 设计 Mxnet 模型对应的 proto 数据结构, 完成对 MxnetNode 和 MxnetParams 的封装</h3><p>为了使得代码在设计层面上的抽象程度更高, 这里需要将 mxnet 的网络结构和参数信息都封装在 protobuf 结构中, 这样做的好处是可以统一模型转换的中间数据结构, 同时也为以后进行其他类型模型转换时提供了代码复用的可能. 同样, 由于这部分的代码也比较多, 因此, 这里只给出少部分代表性的 proto 数据设计, 具体代码如下所示:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">message LayerParameter &#123;</span><br><span class="line">	required <span class="built_in">string</span> name = <span class="number">1</span>; <span class="comment">// the layer name</span></span><br><span class="line">	optional <span class="built_in">string</span> type = <span class="number">2</span>; <span class="comment">// the layer type</span></span><br><span class="line">	repeated LayerInput inputs = <span class="number">3</span>; <span class="comment">// the name of each bottom blob</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// The train / test phase for computation.</span></span><br><span class="line">	optional Phase phase = <span class="number">6</span>;</span><br><span class="line">	optional ConcatParameter concat_param = <span class="number">104</span>;</span><br><span class="line">	optional ConvolutionParameter convolution_param = <span class="number">106</span>;</span><br><span class="line">	optional DropoutParameter dropout_param = <span class="number">108</span>;</span><br><span class="line">	optional InnerProductParameter inner_product_param = <span class="number">117</span>;</span><br><span class="line">	optional ReLUParameter relu_param = <span class="number">123</span>;</span><br><span class="line">	optional PoolingParameter pooling_param = <span class="number">121</span>;</span><br><span class="line">	optional SoftmaxParameter softmax_param = <span class="number">125</span>;</span><br><span class="line">	optional SliceParameter slice_param = <span class="number">126</span>;</span><br><span class="line">	optional FlattenParameter flatten_param = <span class="number">135</span>;</span><br><span class="line">	optional BatchNormParameter batch_norm_param = <span class="number">139</span>;</span><br><span class="line">	optional EltwiseParameter eltwise_param = <span class="number">110</span>;</span><br><span class="line">    <span class="comment">// continue...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message NetParameter &#123;</span><br><span class="line">	optional <span class="built_in">string</span> name = <span class="number">1</span>;</span><br><span class="line">	repeated LayerParameter layer = <span class="number">100</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在定义了相应的 proto 数据结构后, 下面是对应的 Mxnet 到 protoNet 的转换代码(同理, 由于篇幅问题, 只能给出函数声明和调用关系):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MxnetNode2ProtoLayer</span><span class="params">(MxnetNode mxnetNode,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;MxnetParam&gt; &amp;mxnetParams,</span></span></span><br><span class="line"><span class="function"><span class="params">		mxproto::LayerParameter &amp;mxLayer, <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//... too long to show</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mxproto::<span class="function">NetParameter <span class="title">MxnetNodes2ProtoNet</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;MxnetNode&gt; &amp;mxnetNodes,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;MxnetParam&gt; &amp;mxnetParams,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">size_t</span>&gt; &amp;sortedIndices,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;InputInfo&gt; &amp;inputInfos)</span></span>&#123;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;mxproto::LayerParameter&gt; TRTLayers;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="keyword">size_t</span>&gt; typeCnt; <span class="comment">// for unamed layers</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; sortedIndices.size(); ++i) &#123;</span><br><span class="line">		<span class="keyword">auto</span> &amp;mxnetNode = mxnetNodes[sortedIndices[i]];</span><br><span class="line">		mxproto::LayerParameter TRTLayer;</span><br><span class="line">		MxnetNode2ProtoLayer(mxnetNode, mxnetParams, TRTLayer, sortedIndices[i]);</span><br><span class="line">		<span class="comment">// Put this layer to vector</span></span><br><span class="line">		TRTLayers.emplace_back(<span class="built_in">std</span>::move(TRTLayer));</span><br><span class="line">	&#125;</span><br><span class="line">	mxproto::NetParameter net;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;layer : TRTLayers) &#123;</span><br><span class="line">		net.add_layer()-&gt;CopyFrom(layer);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> net;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mxproto::<span class="function">NetParameter <span class="title">ParseMxnetModel</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> strSymbolFn,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="built_in">std</span>::<span class="built_in">string</span> strParamsFn, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;InputInfo&gt; &amp;inputInfos)</span> </span>&#123;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">size_t</span>&gt; headIndices;</span><br><span class="line">	<span class="keyword">auto</span> mxnetNodes = ParseMxnetJson(strSymbolFn, headIndices);</span><br><span class="line">	<span class="keyword">auto</span> mxnetParams = LoadMxnetParam(strParamsFn);</span><br><span class="line">	<span class="keyword">auto</span> sortedIndices = GetSortedIndicesByDependencies(mxnetNodes, headIndices);</span><br><span class="line"></span><br><span class="line">	mxproto::NetParameter protoNet = MxnetNodes2ProtoNet(mxnetNodes, mxnetParams,</span><br><span class="line">			sortedIndices, inputInfos);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//... too long to show</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-根据封装好的-protobuf-数据-填充-TensorRT-的-INetworkDefinition-实例对象"><a href="#5-根据封装好的-protobuf-数据-填充-TensorRT-的-INetworkDefinition-实例对象" class="headerlink" title="(5). 根据封装好的 protobuf 数据, 填充 TensorRT 的 INetworkDefinition 实例对象"></a>(5). 根据封装好的 protobuf 数据, 填充 TensorRT 的 <code>INetworkDefinition</code> 实例对象</h3><p>在得到封装好的 protobuf 数据以后, 就可以根据 protobuf 数据中的属性来填充 TensorRT 模型, 填充方法是首先定义一个空的 <code>nvinfer1::INetworkDefinition</code> 对象, 然后根据 protobuf 中的网络层类型调用不同的成员函数, 如: <code>addConvolution</code>, <code>addActivation</code> 等等, 另外还需要根据之前排好序的节点编号将各个网络层的输入输出串接起来, 使得输入数据可以正确的在网络中执行前向计算, 最终还要特别标记输出层的数据, 以便得到最终的预测结果. 同样, 关于这里的代码实现也非常长, 因此只给出关键的类定义和函数声明和它们的调用关系, 具体代码如下所示:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TRTNetworkPtr</span> :</span> <span class="keyword">public</span> INetDefPtr &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">enum</span> <span class="class"><span class="keyword">class</span> <span class="title">POOLING_ROUNDMODE</span>&#123;</span> UNDEF = <span class="number">0</span>, FULL = <span class="number">1</span>, VALID = <span class="number">2</span>&#125;;</span><br><span class="line"></span><br><span class="line">	TRTNetworkPtr(INetDef *pNetwork)</span><br><span class="line">			: INetDefPtr(pNetwork, <span class="built_in">std</span>::bind(</span><br><span class="line">					&amp;TRTNetworkPtr::NetDefDeleter, <span class="keyword">this</span>, ph::_1)) &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">float</span>* <span class="title">GetWeight</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> strName, <span class="keyword">size_t</span> nSize)</span> </span>&#123;</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">float</span>&gt; &amp;buf = m_WeightMap[strName];</span><br><span class="line">		buf.resize(nSize);</span><br><span class="line">		<span class="keyword">return</span> buf.data();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">NetDefDeleter</span><span class="params">(INetDef *pNetDef)</span> </span>&#123;</span><br><span class="line">		pNetDef-&gt;destroy();</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">SetPoolRoundMode</span><span class="params">(POOLING_ROUNDMODE roundMode)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;nvi::IOutputDimensionsFormula&gt; m_pPoolRoundFormula;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">float</span>&gt;&gt; m_WeightMap;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ProtoNet2TRTNet</span><span class="params">(<span class="keyword">const</span> mxproto::NetParameter &amp;protoNet,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;InputInfo&gt; &amp;inputInfos,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; &amp;outputNames,</span></span></span><br><span class="line"><span class="function"><span class="params">		TRTNetworkPtr &amp;pNetwork)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//... too long to show</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="6-将填充好的-INetworkDefinition-返回-完成引擎模型的转换工作"><a href="#6-将填充好的-INetworkDefinition-返回-完成引擎模型的转换工作" class="headerlink" title="(6). 将填充好的 INetworkDefinition 返回, 完成引擎模型的转换工作."></a>(6). 将填充好的 <code>INetworkDefinition</code> 返回, 完成引擎模型的转换工作.</h3><p>当获取到正确填充后的 <code>nvinfer1::INetworkDefinition</code> 对象实例后, 需要将其转换成项目接受的引擎模型格式, 同样由于篇幅问题, 这里只给出最关键的核心函数的代码实现, 如下所示:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MxnetToTRTModel</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> strSymbolFn, <span class="built_in">std</span>::<span class="built_in">string</span> strParamsFn,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">const</span> ei::ModelInfo &amp;modelConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">unsigned</span> <span class="keyword">int</span> maxBatchSize, MODE mode,</span></span></span><br><span class="line"><span class="function"><span class="params">		nvcaffeparser1::IPluginFactory *pPluginFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">		nvi::IHostMemory** trtModelStream)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Preparing for pNetwork (nvinfer1::INetworkDefinition*)</span></span><br><span class="line">	<span class="keyword">auto</span> pLog = &amp;gLogger;</span><br><span class="line">	CHECK_NOTNULL(pLog);</span><br><span class="line">	<span class="keyword">auto</span> pBuilder = nvi::createInferBuilder(*pLog);</span><br><span class="line">	CHECK_NOTNULL(pBuilder);</span><br><span class="line">	trt::TRTNetworkPtr pNetwork(pBuilder-&gt;createNetwork());</span><br><span class="line"></span><br><span class="line">	CHECK_NOTNULL(pNetwork);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Parse mxnet model to MxnetProto</span></span><br><span class="line">	<span class="keyword">auto</span> protoNet = mxparser::ParseMxnetModel(strSymbolFn, strParamsFn,</span><br><span class="line">			modelConfig.inputInfos);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Convert MxnetProto to trtNet</span></span><br><span class="line">	trt::ProtoNet2TRTNet(protoNet, modelConfig.inputInfos,</span><br><span class="line">			modelConfig.outputNames, pNetwork);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Create TensorRT engine</span></span><br><span class="line">	pBuilder-&gt;setMaxBatchSize(<span class="number">1</span>);</span><br><span class="line">	pBuilder-&gt;setMaxWorkspaceSize(<span class="number">36</span> &lt;&lt; <span class="number">20</span>);</span><br><span class="line">	pBuilder-&gt;setFp16Mode(<span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">auto</span> pEngine = pBuilder-&gt;buildCudaEngine(*pNetwork);</span><br><span class="line">	CHECK_NOTNULL(pEngine);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Serialize trtNet to memory</span></span><br><span class="line">	(*trtModelStream) = pEngine-&gt;serialize();</span><br><span class="line">	pEngine-&gt;destroy();</span><br><span class="line">	pBuilder-&gt;destroy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-EasyInfer-的-C-接口封装"><a href="#2-EasyInfer-的-C-接口封装" class="headerlink" title="2. EasyInfer 的 C 接口封装"></a>2. EasyInfer 的 C 接口封装</h2><p>由于实际项目需求, 我们需要提供 EasyInfer 的纯 C 语言接口, 该任务的完成思路主要是将现有的 C++ 接口进行封装, 并对外提供统一完善的 API C 接口, 下面是较为主要的一些数据结构和函数的声明.<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Copyright (C) DeepGlint, Inc - All Rights Reserved</span></span><br><span class="line"><span class="comment">* Unauthorized copying of this file, via any medium is strictly prohibited</span></span><br><span class="line"><span class="comment">* Proprietary and confidential</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* C API Header</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* Written by Zhao Zheng &lt;zhengzhao@deepglint.com&gt;, Jan. 2019</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"easyinfer/common.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//extern "C" &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> UInt8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> x;</span><br><span class="line">	<span class="keyword">int</span> y;</span><br><span class="line">&#125; POINT, *PPOINT;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... too long to show</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">float</span> first;</span><br><span class="line">	<span class="keyword">float</span> second;</span><br><span class="line">&#125; LIVESCORE, *PLIVESCORE;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LMK_PTS 72</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	POINT2F v[LMK_PTS];</span><br><span class="line">&#125; LMKS, *PLMKS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">MAT</span> <span class="title">MAT</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> MAT* PMAT;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">CreateMatFromImage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *imgPath, PMAT *ppMat)</span></span>;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">CreateMat</span><span class="params">(<span class="keyword">int</span> rows, <span class="keyword">int</span> cols, <span class="keyword">int</span> channels, MAT **ppMat)</span></span>;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">DestroyMat</span><span class="params">(PMAT pMat)</span></span>;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">SetImgData</span><span class="params">(PMAT pMat, UInt8 *pImgData)</span></span>;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">GetRows</span><span class="params">(PMAT pMat, <span class="keyword">int</span> *rows)</span></span>;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">GetCols</span><span class="params">(PMAT pMat, <span class="keyword">int</span> *cols)</span></span>;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">GetChannels</span><span class="params">(PMAT pMat, <span class="keyword">int</span> *channels)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">CONFBOXES</span> <span class="title">CONFBOXES</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> CONFBOXES* PCONFBOXES;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">CreateConfBoxes</span><span class="params">(CONFBOXES **ppConfBoxes)</span></span>; <span class="comment">//Invisible to user</span></span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">DestroyConfBoxes</span><span class="params">(PCONFBOXES pConfBoxes)</span></span>;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">GetConfBoxesSize</span><span class="params">(PCONFBOXES pConfBoxes, <span class="keyword">int</span> *size)</span></span>;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">GetConf</span><span class="params">(PCONFBOXES pConfBoxes, <span class="keyword">int</span> i, <span class="keyword">float</span> *conf)</span></span>;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">GetBox</span><span class="params">(PCONFBOXES pConfBoxes, <span class="keyword">int</span> i, PRECT2F pRect2f)</span></span>;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">GetConfBox</span><span class="params">(PCONFBOXES pConfBoxes, <span class="keyword">int</span> i, <span class="keyword">float</span> *conf, PRECT2F pRect2f)</span></span>;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">AddConfBox</span><span class="params">(PCONFBOXES pConfBoxes, <span class="keyword">float</span> conf, RECT2F rect2f)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">FLOATS</span> <span class="title">FLOATS</span>, *<span class="title">PFLOATS</span>;</span></span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">CreateFloats</span><span class="params">(PFLOATS *ppFloats)</span></span>;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">DestroyFloats</span><span class="params">(PFLOATS pFloats)</span></span>;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">GetFloatsSize</span><span class="params">(PFLOATS pFloats, <span class="keyword">float</span> *size)</span></span>;</span><br><span class="line"><span class="function">EXPORT <span class="keyword">void</span> <span class="title">GetFloatVal</span><span class="params">(PFLOATS pFloats, <span class="keyword">int</span> i, <span class="keyword">float</span> *res)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... continue</span></span><br></pre></td></tr></table></figure></p>
<h2 id="3-添加-OPENVINO-推理引擎底层支持"><a href="#3-添加-OPENVINO-推理引擎底层支持" class="headerlink" title="3. 添加 OPENVINO 推理引擎底层支持"></a>3. 添加 OPENVINO 推理引擎底层支持</h2><p>OpenVINO 是英特尔推出的一个视觉推理和神经网络优化的工具包, 可以让开发人员在主流深度学习框架上(TensorFlow, MXNet, Caffe 等)构建和训练人工智能模型, 并将其部署到各种产品中. EasyInfer 对于该引擎也提供了支持, 主要分以下四步完成:</p>
<ol>
<li>模型转换</li>
<li>初始化</li>
<li>执行计算</li>
<li>获取输出结果</li>
</ol>
<h3 id="1-模型转换"><a href="#1-模型转换" class="headerlink" title="(1). 模型转换"></a>(1). 模型转换</h3><p>OpenVINO 官方提供了相应的模型转换工具: <code>mo.py</code>, 因此, 我们通过在 C++ 代码中执行该脚本, 来将用户的模型文件转换成 OpenVINO 所支持的文件格式:<code>.xml</code>和<code>.bin</code>. 然后, 我们将这些生成的文件中的数据写入到 Buffer 中, 最终将其以一个<code>.VINOEngine</code>结尾的文件进行存储, 这也是 EasyInfer 所接受的文件格式之一.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _ConvertModel2Mem(ei::ModelInfo &amp;modelInfo,</span><br><span class="line">		<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;strModelType,</span><br><span class="line">		<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; &amp;modelFiles,</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">string</span> &amp;strModelBuf,</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">string</span> strWorkPath) <span class="keyword">const</span> override;</span><br></pre></td></tr></table></figure>
<h3 id="2-初始化"><a href="#2-初始化" class="headerlink" title="(2). 初始化"></a>(2). 初始化</h3><p>完成模型文件的转换后, 根据相应的信息进行一些初始化工作, 其中包括基本类的初始化, 数据参数的数据化, 底层引擎的注册等</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _Initialize(<span class="keyword">const</span> ModelInfo &amp;modelInfo,</span><br><span class="line">		<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;strEngineData) override;</span><br></pre></td></tr></table></figure>
<h3 id="3-执行计算"><a href="#3-执行计算" class="headerlink" title="(3). 执行计算"></a>(3). 执行计算</h3><p>在得到了网络模型的结构和参数信息, 就可以根据用户的输入来执行推理计算, 代码实现如下所示.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _CalculateInputs(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Blob&gt; &amp;blobs) override;</span><br></pre></td></tr></table></figure>
<h3 id="4-获取输出结果"><a href="#4-获取输出结果" class="headerlink" title="(4). 获取输出结果"></a>(4). 获取输出结果</h3><p>最终, 将计算的结果存储到 Buffer 中传送给用户, 由用户自行决定如何使用这些结果.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _DownloadOutputs(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Blob&gt; &amp;outputBlobs) override;</span><br></pre></td></tr></table></figure>
<h1 id="三-遇到的问题"><a href="#三-遇到的问题" class="headerlink" title="三. 遇到的问题"></a>三. 遇到的问题</h1><p>/usr/local/libopencv, cmake, ncnn, tensorRT</p>
<p>python 的封装是用 Boost 中的组件完成的.</p>
<h2 id="experimental-filesystem"><a href="#experimental-filesystem" class="headerlink" title="experimental/filesystem"></a>experimental/filesystem</h2><p>gcc 4.8 缺少 stdc++fs<br>gcc 版本需指定到5.0以上<br><a href="https://blog.csdn.net/PCaiyue/article/details/82117895" target="_blank" rel="noopener">https://blog.csdn.net/PCaiyue/article/details/82117895</a></p>
<h2 id="CMAKE-相关"><a href="#CMAKE-相关" class="headerlink" title="CMAKE 相关"></a>CMAKE 相关</h2><p><code>APPEND</code> 指令要求cmake必须在3.5以上</p>
<p>undefined reference to: 说明没有找到相关的库, 有可能是链接错了, 或者路径找错了, 例如include的是opencv4.0, 使用的确实opencv3.4的库</p>
<p>cpp 链接or编译错误 调试方法: 学会使用 demangle, ld, ldd, lddtree 等等</p>
<h2 id="cpp"><a href="#cpp" class="headerlink" title="cpp"></a>cpp</h2><p>g++ -std=c++11 -I/train/results/tensorRT/TensorRT-5.0.2.6/include -L/train/results/tensorRT/TensorRT-5.0.2.6/lib -L/usr/local/cuda/lib64 -L/usr/local/cuda/lib64/stubs main.cpp -lnvinfer_static -lcuda -lcublas -lcudart -lcudnn -lcurand -lnvparsers_static -lprotobuf -o main</p>
<p>符号表<br>.a: 相当于是一部分, 只要连进来就不会再出去, 会把库中的所有内容都加进来, 链接的时候直接添加.a的文件路径, 无需任何前缀<br>.so: 链接的时候会先链进来到符号表中, 然后根据函数或者变量的使用情况进行剪枝, 如果发现没有使用任何内容, 那么就不会吧.so库中的内容加起来, 链接的时候需要时候 -l 前缀</p>
<h2 id="TensorRT-没有BN的API"><a href="#TensorRT-没有BN的API" class="headerlink" title="TensorRT 没有BN的API"></a>TensorRT 没有BN的API</h2><p>利用两个 Scale 实现</p>
<h2 id="TensorRT-的池化层不支持更改-ceil-valid-和-floor-full-模式"><a href="#TensorRT-的池化层不支持更改-ceil-valid-和-floor-full-模式" class="headerlink" title="TensorRT 的池化层不支持更改 ceil(valid) 和 floor(full) 模式"></a>TensorRT 的池化层不支持更改 ceil(valid) 和 floor(full) 模式</h2><p>利用<code>setPoolingOutputDimensionsFormula</code>接口进行全局设置, 如果中途被更改, 则应向用户报错.</p>
<h2 id="protobuf-内置问题"><a href="#protobuf-内置问题" class="headerlink" title="protobuf 内置问题"></a>protobuf 内置问题</h2><p>需要将封装protobuf到easyinfer中, 但是ncnn本身也要使用protobuf, 因此要先对protobuf进行编译</p>
<p>直接问题: easyinfer定制版要做到无任何外部依赖, 但是内部继承的ncnn使用了protobuf, 而ei自身也使用了protobuf, 我们在编译自身项目的时候, 会正确的编译子模块的protobuf, 但是在编译子模块ncnn的时候, 他使用的是系统的protobuf, 如果系统没有装protobuf, 那么就会报错. (ncnn作为子模块, 无需任何改动, 可以与官方同步更新, protobuf因为删减了很多东西, 需要重新编写CMakeList, 因此不能同步更新, 事实上,我们也不需要更新protubf, 足够 ncnn 和 easyinfer 的使用需求),</p>
<p>解决上面的问题的方法之一就是在 CMakeLists.txt 中调用<code>FindNCNN.cmake</code>的时候, 显示的指定其 <code>Module_PATH</code>, 使它指向工程项目的cmake文件夹, 从而可以找到<code>FindNCNN.cmake</code>文件.<br>但是这个问题虽然可以这样解决, 但是又会带来下面的新问题.</p>
<p>问题1: 主项目的CMakeLists.txt和NCNN中的tools里面的caffe, tf, onnx里面都有自身的CMakeList.txt, 他们都有<code>find_package(protobuf)</code>调用语句. 这个时候就会重复执行 protobuf 的 cmake 文件, 从而产生错误, 解决方法是在<code>FindProtobuf.cmake</code>里面设置一个变量, 然后检查是否之前已经执行过<code>FindProtobuf.cmake</code>, 如果执行过, 就不再执行, 这里需要注意的是, 不同的CMakeLists文件调用<code>.cmake</code>文件时, 变量不会共享值. 因此, 我们必须在<code>FindNCNN.cmake</code>文件里面, 用-D选项将该值传递. 因为主项目的CMakeList.txt里面会find_package(ncnn), 所以利用-D选项将主项目里面的值传递过来, 这样, 在NCNN里面tools的三个CMakeList文件都能够获取该值.<br>最新更新: IF(NOT EXISTS ${PROTOBUF_PROTOC_EXECUTABLE}), 用该语句可以更加合理的控制只进行一次make, 并且不会受到大CMakeLists中<code>FindPackage</code>语句的顺序影响.</p>
<p>问题2: PROTOBUF_BUILD_DIR会根据CMAKE_BINARY_PATH的值来设置生成的protoc执行文件的位置, 但是CMAKE_BINARY_PATH 会随着context的不同改变自身的值, 在主项目中的CMakeList.txt中调用FindProtobuf.cmake的时候, protoc的路径是正确的,即easyinfer/build/protobuf/protoc. 但是子项目NCNN的CMakeLists也会执行一次Find_package(protobuf), 而此时CMAKE_BINARY_PATH的值就变成了easyinfer/3rdparty/ncnn/protobuf/protoc了, 但是我们生成的protoc是在build里面的, 所以此时就会报错找不到protoc. 解决方法是加一个变量, 强行把路径指到主项目的路径下. 这样, 最后make的时候路径才回正确(在make的时候才会令ncnn调用FindProtobuf.cmake)<br>SET(PROTO_BINARY_DIR “${CMAKE_BINARY_DIR}/protobuf”)</p>
<p>问题3: 当所有路径的库依赖设置正确以后, 又有一个问题, 就是在第一遍make的时候, ncnn还是提示找不到protoc, 这个时候你直接在打一遍 make 就可以正常通过, 就是说这个时候确实已经生成了protoc, 也确实设置了正确的路径和选项, 但是不知道什么原因, ncnn看不到这个已经生成的protoc. 这个问题虽然看起来不太难解决, 但是也不太好处理, 因为我们的项目很大, 使用多线程make, 整个make大概需要5min的时候, 如果单线程make的话, 就会很慢很慢. 但是多线程失败后, 再单线程make的话, 就可以直接通过, 而不会报错, 所以不太好直接看到出问题的地方. 出现这个错误的原因是因为, 在多线程编译时<br>有可能会先编译ncnn, 再编译protobuf, 但是ncnn需要protoc程序来生成<code>src/engine/proto/</code>文件夹下的.pb.cc和.pb.h文件, 如果此时没有编译好protoc, 那么就会报错. 但问题是ncnn应该是依赖于protobuf的, 为什么会先编译ncnn呢. 后来发现其实ncnn内部并没有添加强依赖, 而第二次编译通过的原因可能就是此时把 protoc 又给正确生成了. 所以第二遍可以过去, 这里面有一个随机性, 因此这个能编译过去也是一种侥幸, 如果改变文件中一些语句的位置, 使得对随机种子添加一些扰动, 那么就有可能又编不过去了. 出现这个错误的主要原因是NCNN中并没有对protobuf加ADD_DEPENDENCISE(ncnn, protobuf)依赖, 我们之前以为NCNN肯定对protobuf加了依赖. 因为它的官方就说了必须要装protobuf才可以, 后来才发现, 官网想表达的意思是你在装ncnn之前, protobuf的protoc可执行程序就必须已经存在于系统中, 它是默认你存在的, 如果不存在就会告诉你未找到, 后来我们在NCNN中tools/caffe的CMakeLists里面找, 还真的没找到加依赖的语句, 因此, 我们就在FindNCNN.camke文件里面, 添加了FindPackage(Protobuf REQUIRED) 和 ADD_DEPENDENCIES(ncnn, protobuf)两句话, 然后就确保了在编译安装ncnn之前, 一定会先把protoc给安装好, 这样就不会错误提示未找到protoc了.</p>
<p>ncnn 要用protoc生成caffe/tf/onnx下的.cc和.h文件, 然后ncnn会使用这些文件</p>
<p>这中间还有很多依赖库的设置问题(libprotobuf.a), 各种编译选项的设置问题(-lpthread), 等等等等</p>
<p>回看的话感觉好像不是那么难, 但是当时调试的时候并不知道问题具体出错在哪了, 因为明明正确生成了protoc, 但是ncnn却显示找不到, 而且当时对cmake和make的流程也不是特别熟悉, 所以这个bug调了很久(一整天, 印象很深刻)</p>
<h2 id="定制版-easyinfer-的命名空间问题"><a href="#定制版-easyinfer-的命名空间问题" class="headerlink" title="定制版 easyinfer 的命名空间问题"></a>定制版 easyinfer 的命名空间问题</h2><p>由于定制版的 easyinfer 不使用任何依赖, 也就是说我们需要将 protobuf 和 opencv 全部内置到 easyinfer 中(内部需求), 这个时候, 命名空间就会出现问题, 以 opencv 举例来说, 当 easyinfer 底层使用类似于<code>cv::imread()</code>这样的语句时, 如果此时用户的系统中已经安装了其他版本的 opencv, 那么在编译连接的时候, 就有可能会链接到用户自己安装的opencv库中, 而在程序其他地方有可能会使用内置的opencv库, 又或者是版本之间的兼容性等等问题, 往往就会报类似 <code>undefined reference</code> 的错误. 对于 protobuf 来说也是同理, 对于 <code>google::</code> 来说, 也会报出相应的错误.<br>解决上面问题的方案是(不是最好的方案, 但是是目前正在使用的方案): 修改自定义 opencv 和 protobuf 的命名空间, 将<code>cv::</code>修改成<code>CV::</code>, <code>google::</code>修改成<code>Google::</code>. 实际上, 在opencv内部也使用了自己封装的protobuf, 它采取了和我们类似的解决方案, 也就是将protobuf的命名空间改成了<code>google_private::</code>.</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>pkg-config 查询opencv 文件是根据 opencv.pc 里面的文本输出的</p>
<p>-L 指定路径 -l 会在 L 指定的路径想进行搜索, 链接对应的文件</p>
<p>ImportError: cannot import name main when running pip —version command in windows7 32 bit</p>
<p><a href="https://stackoverflow.com/questions/28210269/importerror-cannot-import-name-main-when-running-pip-version-command-in-windo" target="_blank" rel="noopener">https://stackoverflow.com/questions/28210269/importerror-cannot-import-name-main-when-running-pip-version-command-in-windo</a><br>报错<br>Traceback (most recent call last):<br>  File “/usr/bin/pip3”, line 9, in <module><br>    from pip import main<br>ImportError: cannot import name ‘main’</module></p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/z_post/计算机视觉-RethinkingImageNetPre-training/" rel="prev" title="Rethinking ImageNet Pre-training">
                <i class="fa fa-chevron-left"></i> Rethinking ImageNet Pre-training
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/z_post/计算机视觉-M2Det-AAAI2019/" rel="next" title="M2Det (AAAI, 2019)">
                M2Det (AAAI, 2019) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar_zz.png"
                alt="ZeroZone" />
            
              <p class="site-author-name" itemprop="name">ZeroZone</p>
              <p class="site-description motion-element" itemprop="description">并不是什么厉害的地方<br>只是一个安静的学习角落</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">263</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">13</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/hellozhaozheng" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:hellozhaozheng@foxmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.csdn.net/ksws0292756" title="零域CSDN博客" target="_blank">零域CSDN博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://xinghanzzy.github.io/" title="BoXiao的博客" target="_blank">BoXiao的博客</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://oldpan.me/" title="Oldpan的博客" target="_blank">Oldpan的博客</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一-项目简介"><span class="nav-text">一. 项目简介</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#源码架构"><span class="nav-text">源码架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模型转换"><span class="nav-text">模型转换</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模型运行"><span class="nav-text">模型运行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ModelBase-实例"><span class="nav-text">ModelBase 实例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#C-接口用法"><span class="nav-text">C++ 接口用法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Python-接口用法"><span class="nav-text">Python 接口用法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二-负责任务"><span class="nav-text">二. 负责任务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-MXNet-模型到-TensorRT-模型的转换"><span class="nav-text">1. MXNet 模型到 TensorRT 模型的转换</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-设计能够封装-MXNet-模型文件信息的数据结构"><span class="nav-text">(1). 设计能够封装 MXNet 模型文件信息的数据结构.</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-解析-MXNet-模型文件-json-和-params"><span class="nav-text">(2). 解析 MXNet 模型文件(.json 和 .params)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-根据节点的输入输出关系-对网络层节点进行排序"><span class="nav-text">(3). 根据节点的输入输出关系, 对网络层节点进行排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-设计-Mxnet-模型对应的-proto-数据结构-完成对-MxnetNode-和-MxnetParams-的封装"><span class="nav-text">(4). 设计 Mxnet 模型对应的 proto 数据结构, 完成对 MxnetNode 和 MxnetParams 的封装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-根据封装好的-protobuf-数据-填充-TensorRT-的-INetworkDefinition-实例对象"><span class="nav-text">(5). 根据封装好的 protobuf 数据, 填充 TensorRT 的 INetworkDefinition 实例对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-将填充好的-INetworkDefinition-返回-完成引擎模型的转换工作"><span class="nav-text">(6). 将填充好的 INetworkDefinition 返回, 完成引擎模型的转换工作.</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-EasyInfer-的-C-接口封装"><span class="nav-text">2. EasyInfer 的 C 接口封装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-添加-OPENVINO-推理引擎底层支持"><span class="nav-text">3. 添加 OPENVINO 推理引擎底层支持</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-模型转换"><span class="nav-text">(1). 模型转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-初始化"><span class="nav-text">(2). 初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-执行计算"><span class="nav-text">(3). 执行计算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-获取输出结果"><span class="nav-text">(4). 获取输出结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三-遇到的问题"><span class="nav-text">三. 遇到的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#experimental-filesystem"><span class="nav-text">experimental/filesystem</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CMAKE-相关"><span class="nav-text">CMAKE 相关</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cpp"><span class="nav-text">cpp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TensorRT-没有BN的API"><span class="nav-text">TensorRT 没有BN的API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TensorRT-的池化层不支持更改-ceil-valid-和-floor-full-模式"><span class="nav-text">TensorRT 的池化层不支持更改 ceil(valid) 和 floor(full) 模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#protobuf-内置问题"><span class="nav-text">protobuf 内置问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定制版-easyinfer-的命名空间问题"><span class="nav-text">定制版 easyinfer 的命名空间问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他"><span class="nav-text">其他</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZeroZone</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">2.5m</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">37:45</span>
  
</div>










  <div class="footer-custom">勤练带来力量</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  



  





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>





  
  

  
  

  
    
      <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      TeX: {equationNumbers: { autoNumber: "AMS" }}
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  
  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>


</body>
</html>
